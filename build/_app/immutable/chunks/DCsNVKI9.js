const U=16.666666666666668,w=typeof performance<"u"?()=>performance.now():()=>Date.now(),A=typeof window<"u"?t=>window.requestAnimationFrame(t):t=>setTimeout(()=>t(w()),U);function F(t){let e=[],i=[],s=0,n=!1,r=!1;const u=new WeakSet,p={schedule:(o,c=!1,f=!1)=>{const S=f&&n,v=S?e:i;return c&&u.add(o),v.indexOf(o)===-1&&(v.push(o),S&&n&&(s=e.length)),o},cancel:o=>{const c=i.indexOf(o);c!==-1&&i.splice(c,1),u.delete(o)},process:o=>{if(n){r=!0;return}if(n=!0,[e,i]=[i,e],i.length=0,s=e.length,s)for(let c=0;c<s;c++){const f=e[c];f(o),u.has(f)&&(p.schedule(f),t())}n=!1,r&&(r=!1,p.process(o))}};return p}const V=40;let m=!0,h=!1,y=!1;const a={delta:0,timestamp:0},l=["read","update","preRender","render","postRender"],d=l.reduce((t,e)=>(t[e]=F(()=>h=!0),t),{}),g=l.reduce((t,e)=>{const i=d[e];return t[e]=(s,n=!1,r=!1)=>(h||z(),i.schedule(s,n,r)),t},{}),P=l.reduce((t,e)=>(t[e]=d[e].cancel,t),{}),D=l.reduce((t,e)=>(t[e]=()=>d[e].process(a),t),{}),R=t=>d[t].process(a),x=t=>{h=!1,a.delta=m?U:Math.max(Math.min(t-a.timestamp,V),1),a.timestamp=t,y=!0,l.forEach(R),y=!1,h&&(m=!1,A(x))},z=()=>{h=!0,m=!0,y||A(x)},C=()=>a;function N(t,e){return e?t*(1e3/e):0}function T(t,e){t.indexOf(e)===-1&&t.push(e)}function E(t,e){var i=t.indexOf(e);i>-1&&t.splice(i,1)}var b=function(){function t(){this.subscriptions=[]}return t.prototype.add=function(e){var i=this;return T(this.subscriptions,e),function(){return E(i.subscriptions,e)}},t.prototype.notify=function(e,i,s){var n=this.subscriptions.length;if(n)if(n===1)this.subscriptions[0](e,i,s);else for(var r=0;r<n;r++){var u=this.subscriptions[r];u&&u(e,i,s)}},t.prototype.getSize=function(){return this.subscriptions.length},t.prototype.clear=function(){this.subscriptions.length=0},t}(),M=function(t){return!isNaN(parseFloat(t))},O=function(){function t(e,i){var s=this;this.timeDelta=0,this.lastUpdated=0,this.updateSubscribers=new b,this.velocityUpdateSubscribers=new b,this.renderSubscribers=new b,this.canTrackVelocity=!1,this.updateAndNotify=function(n,r){r===void 0&&(r=!0),s.prev=s.current,s.current=n;var u=C(),p=u.delta,o=u.timestamp;s.lastUpdated!==o&&(s.timeDelta=p,s.lastUpdated=o,g.postRender(s.scheduleVelocityCheck)),s.prev!==s.current&&s.updateSubscribers.notify(s.current),s.velocityUpdateSubscribers.getSize()&&s.velocityUpdateSubscribers.notify(s.getVelocity()),r&&s.renderSubscribers.notify(s.current)},this.scheduleVelocityCheck=function(){return g.postRender(s.velocityCheck)},this.velocityCheck=function(n){var r=n.timestamp;r!==s.lastUpdated&&(s.prev=s.current,s.velocityUpdateSubscribers.notify(s.getVelocity()))},this.hasAnimated=!1,this.prev=this.current=e,this.canTrackVelocity=M(this.current),this.onSubscription=()=>{},this.onUnsubscription=()=>{},i&&(this.onSubscription=()=>{if(this.updateSubscribers.getSize()+this.velocityUpdateSubscribers.getSize()+this.renderSubscribers.getSize()===0){const n=i();this.onUnsubscription=()=>{},n&&(this.onUnsubscription=()=>{this.updateSubscribers.getSize()+this.velocityUpdateSubscribers.getSize()+this.renderSubscribers.getSize()===0&&n()})}})}return t.prototype.onChange=function(e){this.onSubscription();const i=this.updateSubscribers.add(e);return()=>{i(),this.onUnsubscription()}},t.prototype.subscribe=function(e){return this.onChange(e)},t.prototype.clearListeners=function(){this.updateSubscribers.clear(),this.onUnsubscription()},t.prototype.onRenderRequest=function(e){this.onSubscription(),e(this.get());const i=this.renderSubscribers.add(e);return()=>{i(),this.onUnsubscription()}},t.prototype.attach=function(e){this.passiveEffect=e},t.prototype.set=function(e,i){i===void 0&&(i=!0),!i||!this.passiveEffect?this.updateAndNotify(e,i):this.passiveEffect(e,this.updateAndNotify)},t.prototype.update=function(e){this.set(e(this.get()))},t.prototype.get=function(){this.onSubscription();const e=this.current;return this.onUnsubscription(),e},t.prototype.getPrevious=function(){return this.prev},t.prototype.getVelocity=function(){this.onSubscription();const e=this.canTrackVelocity?N(parseFloat(this.current)-parseFloat(this.prev),this.timeDelta):0;return this.onUnsubscription(),e},t.prototype.start=function(e){var i=this;return this.stop(),new Promise(function(s){i.hasAnimated=!0,i.stopAnimation=e(s)}).then(function(){return i.clearAnimation()})},t.prototype.stop=function(){this.stopAnimation&&this.stopAnimation(),this.clearAnimation()},t.prototype.isAnimating=function(){return!!this.stopAnimation},t.prototype.clearAnimation=function(){this.stopAnimation=null},t.prototype.destroy=function(){this.updateSubscribers.clear(),this.renderSubscribers.clear(),this.stop(),this.onUnsubscription()},t}();function _(t,e){return new O(t,e)}export{b as S,T as a,P as c,D as f,C as g,_ as m,E as r,g as s,N as v};
